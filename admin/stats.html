<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Visitor Stats — Admin</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: #0f0b1a;
      color: #e2e0ea;
      min-height: 100vh;
      padding: 2rem;
    }
    a { color: #A855F7; }

    .container { max-width: 960px; margin: 0 auto; }

    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      background: linear-gradient(135deg, #6C3CE1, #06B6D4, #F472B6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* ── Login form ─────────────────────────── */
    .login-box {
      background: #1a1528;
      border: 1px solid #2d2640;
      border-radius: 12px;
      padding: 2rem;
      max-width: 400px;
      margin: 4rem auto;
    }
    .login-box h2 { font-size: 1.1rem; margin-bottom: 1rem; }
    .login-box input {
      width: 100%;
      padding: 0.6rem 0.8rem;
      border-radius: 8px;
      border: 1px solid #3d3560;
      background: #0f0b1a;
      color: #e2e0ea;
      font-size: 0.9rem;
      margin-bottom: 0.8rem;
    }
    .login-box input:focus { outline: none; border-color: #6C3CE1; }
    .login-box button, .controls button {
      padding: 0.5rem 1.2rem;
      border-radius: 8px;
      border: none;
      background: #6C3CE1;
      color: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .login-box button:hover, .controls button:hover { background: #5a2fc7; }

    /* ── Controls ───────────────────────────── */
    .controls {
      display: flex;
      gap: 0.6rem;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    .controls select, .controls input[type="date"] {
      padding: 0.45rem 0.7rem;
      border-radius: 8px;
      border: 1px solid #3d3560;
      background: #1a1528;
      color: #e2e0ea;
      font-size: 0.85rem;
    }
    .controls select:focus, .controls input[type="date"]:focus {
      outline: none; border-color: #6C3CE1;
    }
    .tag {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: auto;
    }
    .tag.online { background: rgba(34,197,94,0.15); color: #22c55e; }

    /* ── Summary cards ──────────────────────── */
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card {
      background: #1a1528;
      border: 1px solid #2d2640;
      border-radius: 12px;
      padding: 1.2rem;
    }
    .card .label { font-size: 0.75rem; color: #8b85a0; text-transform: uppercase; letter-spacing: 0.05em; }
    .card .value { font-size: 1.8rem; font-weight: 700; margin-top: 0.3rem; }
    .card .value.purple { color: #A855F7; }
    .card .value.cyan { color: #06B6D4; }
    .card .value.pink { color: #F472B6; }
    .card .value.orange { color: #FB923C; }

    /* ── Bar chart ──────────────────────────── */
    .chart-section { margin-bottom: 1.5rem; }
    .chart-section h3 { font-size: 0.85rem; color: #8b85a0; margin-bottom: 0.8rem; }
    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 120px;
      padding: 0 0.2rem;
    }
    .bar-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-width: 0;
    }
    .bar {
      width: 100%;
      max-width: 40px;
      border-radius: 4px 4px 0 0;
      background: linear-gradient(180deg, #A855F7, #6C3CE1);
      transition: height 0.4s ease;
      min-height: 2px;
    }
    .bar-label {
      font-size: 0.6rem;
      color: #6b6580;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .bar-count {
      font-size: 0.65rem;
      color: #a09ab0;
    }

    /* ── Table ──────────────────────────────── */
    .table-section h3 { font-size: 0.85rem; color: #8b85a0; margin-bottom: 0.8rem; }
    .table-wrap {
      overflow-x: auto;
      border: 1px solid #2d2640;
      border-radius: 12px;
      background: #1a1528;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }
    th {
      text-align: left;
      padding: 0.7rem 0.8rem;
      border-bottom: 1px solid #2d2640;
      color: #8b85a0;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    td {
      padding: 0.55rem 0.8rem;
      border-bottom: 1px solid #1f1a30;
      white-space: nowrap;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(108,60,225,0.05); }
    .ip { font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; color: #A855F7; }
    .flag { margin-right: 0.3rem; }

    /* ── Loading / Empty ───────────────────── */
    .status-msg {
      text-align: center;
      padding: 3rem;
      color: #6b6580;
    }
    .spinner {
      width: 24px; height: 24px;
      border: 3px solid #2d2640;
      border-top-color: #A855F7;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 0.8rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Visitor Stats</h1>

    <!-- Login -->
    <div id="login-box" class="login-box">
      <h2>Enter Admin Token</h2>
      <input type="password" id="token-input" placeholder="ADMIN_TOKEN" autofocus>
      <button id="login-btn">View Stats</button>
    </div>

    <!-- Dashboard (hidden until login) -->
    <div id="dashboard" class="hidden">
      <div class="controls">
        <select id="range-select">
          <option value="1">Today</option>
          <option value="3">Last 3 days</option>
          <option value="7" selected>Last 7 days</option>
          <option value="14">Last 14 days</option>
          <option value="30">Last 30 days</option>
        </select>
        <button id="refresh-btn">Refresh</button>
        <span class="tag online" id="status-tag">Connected</span>
      </div>

      <!-- Summary cards -->
      <div class="summary">
        <div class="card"><div class="label">Total Visits</div><div class="value purple" id="stat-total">—</div></div>
        <div class="card"><div class="label">Unique IPs</div><div class="value cyan" id="stat-ips">—</div></div>
        <div class="card"><div class="label">Countries</div><div class="value pink" id="stat-countries">—</div></div>
        <div class="card"><div class="label">Pages</div><div class="value orange" id="stat-pages">—</div></div>
      </div>

      <!-- Daily chart -->
      <div class="chart-section">
        <h3>Daily Visits</h3>
        <div class="bar-chart" id="daily-chart"></div>
      </div>

      <!-- Country breakdown -->
      <div class="chart-section">
        <h3>Top Countries</h3>
        <div class="bar-chart" id="country-chart"></div>
      </div>

      <!-- Visitor table -->
      <div class="table-section">
        <h3>Recent Visitors</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>IP</th>
                <th>Location</th>
                <th>Page</th>
              </tr>
            </thead>
            <tbody id="visitor-table"></tbody>
          </table>
        </div>
      </div>

      <div id="loading" class="status-msg hidden"><div class="spinner"></div>Loading...</div>
      <div id="empty" class="status-msg hidden">No visitor data yet.</div>
    </div>
  </div>

  <script>
    const API = 'https://comments.arsenelee.com/api/visits';
    let token = '';

    const $ = (id) => document.getElementById(id);

    // Country code → flag emoji
    const flag = (code) => {
      if (!code || code.length !== 2) return '';
      const cp = [...code.toUpperCase()].map(c => 0x1F1E6 + c.charCodeAt(0) - 65);
      return String.fromCodePoint(...cp);
    };

    // ── Login ─────────────────────────────────
    $('login-btn').addEventListener('click', doLogin);
    $('token-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') doLogin(); });

    function doLogin() {
      token = $('token-input').value.trim();
      if (!token) return;
      localStorage.setItem('_admin_token', token);
      $('login-box').classList.add('hidden');
      $('dashboard').classList.remove('hidden');
      fetchData();
    }

    // Auto-login if token saved
    const saved = localStorage.getItem('_admin_token');
    if (saved) {
      token = saved;
      $('token-input').value = token;
      $('login-box').classList.add('hidden');
      $('dashboard').classList.remove('hidden');
      fetchData();
    }

    $('range-select').addEventListener('change', fetchData);
    $('refresh-btn').addEventListener('click', fetchData);

    // ── Fetch & render ────────────────────────
    async function fetchData() {
      const days = $('range-select').value;
      $('loading').classList.remove('hidden');
      $('empty').classList.add('hidden');

      try {
        const res = await fetch(`${API}?token=${encodeURIComponent(token)}&days=${days}`);
        if (res.status === 401) {
          localStorage.removeItem('_admin_token');
          $('dashboard').classList.add('hidden');
          $('login-box').classList.remove('hidden');
          $('token-input').value = '';
          $('token-input').focus();
          alert('Invalid token');
          return;
        }
        const data = await res.json();
        $('status-tag').textContent = 'Connected';
        render(data, parseInt(days));
      } catch (e) {
        $('status-tag').textContent = 'Error';
        console.error(e);
      } finally {
        $('loading').classList.add('hidden');
      }
    }

    function render(data, days) {
      // Flatten all visits
      const allVisits = [];
      const dailyCounts = {};

      // Build sorted date list
      const dates = Object.keys(data).sort();
      for (const date of dates) {
        const day = data[date];
        dailyCounts[date] = day.count;
        for (const v of day.visits) {
          allVisits.push(v);
        }
      }

      if (allVisits.length === 0) {
        $('empty').classList.remove('hidden');
      }

      // Summary
      const uniqueIPs = new Set(allVisits.map(v => v.ip));
      const uniqueCountries = new Set(allVisits.map(v => v.country).filter(Boolean));
      const uniquePages = new Set(allVisits.map(v => v.page).filter(Boolean));

      $('stat-total').textContent = allVisits.length.toLocaleString();
      $('stat-ips').textContent = uniqueIPs.size.toLocaleString();
      $('stat-countries').textContent = uniqueCountries.size.toLocaleString();
      $('stat-pages').textContent = uniquePages.size.toLocaleString();

      // Daily bar chart
      renderBarChart('daily-chart', dates.map(d => ({
        label: d.slice(5), // MM-DD
        count: dailyCounts[d] || 0,
      })));

      // Country breakdown
      const countryCounts = {};
      for (const v of allVisits) {
        const c = v.country || '??';
        countryCounts[c] = (countryCounts[c] || 0) + 1;
      }
      const topCountries = Object.entries(countryCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([code, count]) => ({ label: `${flag(code)} ${code}`, count }));
      renderBarChart('country-chart', topCountries);

      // Visitor table (most recent first, max 200)
      const sorted = [...allVisits].sort((a, b) => new Date(b.ts) - new Date(a.ts)).slice(0, 200);
      const tbody = $('visitor-table');
      tbody.innerHTML = sorted.map(v => {
        const time = new Date(v.ts).toLocaleString();
        const loc = [v.city, v.region, v.country].filter(Boolean).join(', ');
        return `<tr>
          <td>${esc(time)}</td>
          <td class="ip">${esc(v.ip)}</td>
          <td><span class="flag">${flag(v.country)}</span>${esc(loc)}</td>
          <td>${esc(v.page)}</td>
        </tr>`;
      }).join('');
    }

    function renderBarChart(containerId, items) {
      const container = $(containerId);
      if (!items.length) { container.innerHTML = ''; return; }
      const max = Math.max(...items.map(i => i.count), 1);
      container.innerHTML = items.map(item => {
        const h = Math.max(2, (item.count / max) * 100);
        return `<div class="bar-col">
          <span class="bar-count">${item.count}</span>
          <div class="bar" style="height:${h}px"></div>
          <span class="bar-label">${esc(item.label)}</span>
        </div>`;
      }).join('');
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }
  </script>
</body>
</html>
